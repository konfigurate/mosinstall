# ORIGINAL FILE FROM https://github.com/macBerlin/macOS_erase/blob/main/macOS_erase_Monterey
# THIS WAS CHANGED TO WORK WITH ALL VRESIONS: BIG SUR, MONTEREY, VENTURA
# NO WARRANTY OR HELP FROM ME
# https://github.com/konfigurate/mosinstall



# ----------------
# SETUP
# ----------------

#
# BIG SUR
# get it from https://mrmacintosh.com/macos-big-sur-full-installer-database-download-directly-from-apple/
#
bigsur1175=("Big Sur" "11.7.5" "https://swcdn.apple.com/content/downloads/15/42/032-63762-A_6CJ6JOEC74/hdc26sfhq2a4c4x7yvafi9mrbe3jg3xo3d/InstallAssistant.pkg")
bigsur1174=("Big Sur" "11.7.4" "https://swcdn.apple.com/content/downloads/26/54/032-50519-A_CXUH67MIZN/z1mbjod7nna0yhubto3a7pyq1gilhin6fw/InstallAssistant.pkg")
bigsur1173=("Big Sur" "11.7.3" "https://swcdn.apple.com/content/downloads/42/51/032-33756-A_AESP8TG5IZ/etbmyyij5yv83bsn0os00qz6dc92zykvog/InstallAssistant.pkg")

#
# MONTEREY
# get it from https://mrmacintosh.com/macos-12-monterey-full-installer-database-download-directly-from-apple/
#
monterey1163=("Monterey" "12.6.4" "https://swcdn.apple.com/content/downloads/07/41/032-63749-A_38MYH58MVP/0ynlao7ghdixj9sgw8im15vwf4hox0hnzc/InstallAssistant.pkg")
monterey1163=("Monterey" "12.6.3" "https://swcdn.apple.com/content/downloads/17/14/032-33828-A_KX25OQBX8S/lz9yip4rmenyju8nkv4wpaqtdmvzfogkcb/InstallAssistant.pkg")
monterey1262=("Monterey" "12.6.2" "https://swcdn.apple.com/content/downloads/55/35/032-12843-A_35UCTHBNLI/z1twfbx3mhypq6g7ljtz52z6nsv0n7e4o5/InstallAssistant.pkg")

#
# VENTURA
# get from https://mrmacintosh.com/macos-ventura-13-full-installer-database-download-directly-from-apple/
#
ventura133=("Ventura" "13.3" "https://swcdn.apple.com/content/downloads/41/46/002-75541-A_N0W4MFQ0NM/rwkz3k8cd91dvrvddymange3k8004xkt4v/InstallAssistant.pkg")
ventura1321=("Ventura" "13.2.1" "https://swcdn.apple.com/content/downloads/26/15/032-48342-A_OG2YEE7OSX/8sd3qpy79cimb7cjiy47cytps0gm7m0z5l/InstallAssistant.pkg")
ventura132=("Ventura" "13.2" "https://swcdn.apple.com/content/downloads/07/49/032-35706-A_E13VXNW85V/adm3i8lj9k9gmo6swtwto3lv6jc57q8i61/InstallAssistant.pkg")



#
# COLORS
#
GREEN='\033[0;32m'
BLUE='\033[0;34m'  
RED='\033[0;31m'
NC='\033[0m' # No Color



function printInfo() {

    #
    # print info for user when starting
    #

    echo
    echo "+-----------------------------------+
    echo "| mosinstall by konfigurate         |"
    echo "| github.com/konfigurate/mosinstall |"
    echo "| Version 2023.03.27                |"
    echo "+-----------------------------------+"
    echo
    echo -e "${RED}[INFO]: This script can remove all data on your computer! ${NC}"
    echo -e "${RED}[INFO]: Press CTRL-Z to cancel this process anytime! ${NC}"
    echo -e "${GREEN}[INFO]:${NC} Starting processes ..."

}



function eraseDisk() {

    #
    # Asks if drive should be deleted, does so if "Yy" was typed
    # checks erased disks
    #

    if [[ -d '/Volumes/Untitled' ]]; then      
        diskPath='/Volumes/Untitled'
        diskName="Untitled"
    fi

    if [[ -d '/Volumes/Macintosh HD' ]]; then
        diskPath='/Volumes/Macintosh HD'
        diskName="Macintosh HD"
    fi

    echo -e "${GREEN}[INFO]:${NC} Destination disk is: ${diskPath}"
    echo
    echo -e "${RED}[CHOICE]: Do you want to delete all data on this computer? (y/N)${NC}"
    read answer < /dev/tty
    echo
    
    if [ "$answer" != "${answer#[Yy]}" ];then

        echo -e "${GREEN}[INFO]:${NC} Ckecking Volumes ..."
        internalDisk=$(diskutil list | grep "synthesized" | awk -F " " {'print $1'} | awk -F "/" {'print $3'} | head -1)
        echo -e "${GREEN}[INFO]:${NC} APFS synthesized disk is: ${internalDisk}"
        DSK_MACINTOSH_HD=$(diskutil list $internalDisk | grep -i "${diskName}" |  grep -vi "data" | awk {'print $NF'} )
        echo -e "${GREEN}[INFO]:${NC} APFS Macintosh HD disk is: ${DSK_MACINTOSH_HD}"
        DSK_MACINTOSH_HD_DATA=$(diskutil list $internalDisk | grep -i "DATA" | awk {'print $NF'})
        
        if [ -z "$DSK_MACINTOSH_HD_DATA" ];then
            echo -e "${GREEN}[INFO]:${NC} APFS Data HD not found. Skipping."
        else
            echo -e "${GREEN}[INFO]:${NC} APFS Data HD disk is: ${DSK_MACINTOSH_HD_DATA}"
            umount -f /dev/${DSK_MACINTOSH_HD_DATA} /dev/null &> /dev/null
            echo -e "${GREEN}[INFO]:${NC} Deleting Data partition ..."
            diskutil apfs deleteVolume ${DSK_MACINTOSH_HD_DATA} &> /dev/null
        fi

        # erase volume, create new on called "Macintish HD"
        echo -e "${GREEN}[INFO]:${NC} Deleting Macintosh HD ..."
        diskutil apfs eraseVolume ${DSK_MACINTOSH_HD} -name "Macintosh HD" &> /dev/null
        diskPath='/Volumes/Macintosh HD'
        diskName='Macintosh HD'
        diskutil mount /dev/${DSK_MACINTOSH_HD} &> /dev/null

        if [[ $? -ne 0 ]]; then
            echo -e "${RED}[ERROR]:${NC} Error mounting Macintosh HD."
            echo -e "${RED}[ERROR]:${NC} Please delete the volume yourself."
            echo -e "${RED}[ERROR]:${NC} Exiting."
            exit
        fi
    else
        echo -e "${GREEN}[INFO]:${NC} Skipping disk deletion."
    fi

}



function versionPrinter() {

    #
    # `versionPrinter x arrName`
    # will print the array as line x in the selector
    # name version link (link will not be printed)
    # 

    name=$2[@]
    args=("${!name}")

    echo -e "\t${1}. macOS ${args[0]}\t${args[1]}"

}



function downloadInstaller() {

    #
    # creates a Folder in /private/tmp
    # asks what macOS should be installed
    # downloads the installer
    #

    echo -e "${GREEN}[INFO]:${NC} Set up folder ..."
    mkdir -p "${diskPath}"/private/tmp
    cd "${diskPath}/private/tmp/"

    echo
    echo -e "${GREEN}[CHOICE]:${NC} Choose your macOS Version"

    echo
    echo "Ventura:"
    versionPrinter 1 ventura133
    versionPrinter 2 ventura1321
    versionPrinter 3 ventura132

    echo
    echo "Monterey:"
    versionPrinter 4 monterey1264
    versionPrinter 5 monterey1263
    versionPrinter 6 monterey1262

    echo
    echo "Big Sur:"
    versionPrinter 7 bigsur1175
    versionPrinter 8 bigsur1174
    versionPrinter 9 bigsur1173

    echo
    echo -e "${GREEN}[CHOICE]: Enter a number (1..6):${NC}"
    read answer < /dev/tty
    echo

    case $answer in
    
        "1" ) 
            arr=ventura133 ;;
        "2" ) 
            arr=ventura1321 ;;
        "3" )
            arr=ventura132 ;;    
        "4")
            arr=monterey1264 ;;
        "5" )
            arr=monterey1263 ;;
        "6" )
            arr=monterey1262 ;;
        "7" )
            arr=bigsur1175 ;;
        "8" )
            arr=bigsur1174 ;;
        "9" )
            arr=bigsur1173 ;;
        * )
            echo -e "${RED}[INFO]:${NC} Nothing selected, exiting now ..."
            exit
            ;;

    esac

    # load array
    name=$arr[@]
    macOS=("${!name}")

    # get values
    macOSName=${macOS[0]}
    macOSVersion=${macOS[1]}
    macOSUrl=${macOS[2]}

    echo -e "${GREEN}[INFO]:${NC} Downloading macOS ${macOSName} ${macOSVersion} from Apple."
    echo -e "${GREEN}[INFO]:${NC} curl ..."

    curl -L --progress-bar  -f -o InstallAssistant.pkg ${macOSUrl}
    
    if [[ $? -eq 0 ]]; then
        echo -e "${GREEN}[INFO]:${NC} ... done."
    else 
        echo -e "${RED}[ERROR]:${NC} Download failed. Exiting now!"
        exit
    fi

}



function expandAndSet() {

    #
    # Moving files to set up the InstallAssistant
    #

    echo -e "${GREEN}[INFO]:${NC} Expanding Installer ..."
    pkgutil --expand-full InstallAssistant.pkg Source
    echo -e "${GREEN}[INFO]:${NC} Copying in place ..."
    cp -R Source/Payload/Applications/"Install macOS ${macOSName}.app" "${diskPath}"/private/tmp/ &>/dev/null
    
    echo -e "${GREEN}[INFO]:${NC} Adding data ..."
    SSPATH="Install macOS ${macOSName}.app/Contents/SharedSupport"
    mkdir -p "$SSPATH"
    /bin/chmod 0755 "$SSPATH"
    mv InstallAssistant.pkg "$SSPATH"/SharedSupport.dmg

    echo -e "${GREEN}[INFO]:${NC} Changing permissions ..."
    /bin/chmod 0644 "$SSPATH"/SharedSupport.dmg
    /usr/sbin/chown -R root:wheel "$SSPATH"/SharedSupport.dmg
    /usr/bin/chflags -h norestricted "$SSPATH"/SharedSupport.dmg

    echo -e "${GREEN}[INFO]:${NC} Cleanup ..."
    rm -rf Source
    rm -rf InstallAssistant.pkg
    echo -e "${GREEN}[INFO]:${NC} Prerequisites done."

}



function unmountExternalDisks() {

    #
    # will check for external media and will unmount them before installation
    #
    
    echo -e "${GREEN}[INFO]:${NC} Looking for external drives and unmounting ..."
    externalDisk=$(diskutil list | grep external | awk -F " " {'print $1'})
    diskutil umountDisk $externalDisk 2> /dev/null
    echo -e "${GREEN}[INFO]:${NC} ... done."

}



function startInstaller() {

    #
    # prints info and starts installer
    #

    echo -e "${GREEN}[INFO]:${NC} Starting installer ..."
    "${diskPath}/private/tmp/Install macOS ${macOSName}.app"/Contents/MacOS/InstallAssistant_springboard >/dev/null

}



function main() {

    #
    # main runner
    #
    
    printInfo
    eraseDisk

    downloadInstaller
    expandAndSet
    unmountExternalDisks

    startInstaller

}

main